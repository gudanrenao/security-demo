<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhangwenit.security.demo.mapper.SysUserMapper">

    <resultMap id="userMap" type="com.zhangwenit.security.demo.dto.SysUser">
        <id property="id" column="id"/>
        <result property="merchantId" column="merchant_id"/>
        <result property="enabled" column="enabled"/>
        <result property="type" column="type"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <collection property="roles" ofType="com.zhangwenit.security.demo.dto.SysRole">
            <result column="name" property="name"/>
            <result column="description" property="description"/>
        </collection>
    </resultMap>

    <select id="findByUserName" parameterType="java.lang.String" resultMap="userMap">
		select u.id,u.merchant_id,u.enabled,u.type,u.username,u.password,r.name
		from sys_user u
        LEFT JOIN sys_user_role sur on u.id= sur.sys_user_id
        LEFT JOIN sys_role r on sur.sys_role_id=r.id
        where u.username= #{username} and u.is_delete = 0 and r.is_delete = 0
	</select>

    <!--todo: This version of MySQL doesn't yet support 'LIMIT & IN/ALL/ANY/SOME subquery-->
    <select id="userSearchByKeywords" resultMap="userMap">
        select u.id,u.merchant_id,u.enabled,u.type,u.username,u.password,r.name,r.description
        from sys_user u
        LEFT JOIN sys_user_role sur on u.id= sur.sys_user_id
        LEFT JOIN sys_role r on sur.sys_role_id=r.id
        where u.id in (
        select id from sys_user where merchant_id = #{merchantId}
        <if test="keywords!='all' and keywords!=''">
            and `username` like concat('%',#{keywords},'%')
        </if>
        and is_delete = 0 and `type` = 2
        ) and r.is_delete = 0
    </select>

    <update id="updateUser" parameterType="com.zhangwenit.security.demo.dto.SysUser">
        update sys_user
        <set>
            <if test="username != null">
                name = #{username,jdbcType=VARCHAR},
            </if>
            <!--<if test="phone != null">-->
            <!--phone = #{phone,jdbcType=CHAR},-->
            <!--</if>-->
            <!--<if test="address != null">-->
            <!--address = #{address,jdbcType=VARCHAR},-->
            <!--</if>-->
            <!--<if test="userface != null">-->
            <!--userface = #{userface,jdbcType=VARCHAR},-->
            <!--</if>-->
            <!--<if test="remark != null">-->
            <!--remark = #{remark,jdbcType=VARCHAR},-->
            <!--</if>-->
            <if test="enabled != null">
                enabled = #{enabled,jdbcType=BIT},
            </if>
            <if test="username != null">
                username = #{username,jdbcType=VARCHAR},
            </if>
            <if test="password != null">
                password = #{password,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id}
    </update>

    <select id="getUserById" parameterType="java.lang.String" resultMap="userMap">
		select u.id,u.merchant_id,u.enabled,u.type,u.username,u.password,r.name,r.description
		from sys_user u
        LEFT JOIN sys_user_role sur on u.id= sur.sys_user_id
        LEFT JOIN sys_role r on sur.sys_role_id=r.id
        where u.id = #{userId} and r.is_delete = 0
	</select>
</mapper>